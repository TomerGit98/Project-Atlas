name: Deploy to IIS

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject version metadata into web.config
        shell: powershell
        run: |
          $sha = "$env:GITHUB_SHA"
          $bt = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          (Get-Content ".\web.config") `
            -replace "__GIT_SHA__", $sha `
            -replace "__BUILD_TIME__", $bt `
            | Set-Content ".\web.config"

      - name: Deploy files to IIS directory
        shell: powershell
        run: |
          $src = "$env:GITHUB_WORKSPACE"
          $dst = "C:\inetpub\project-atlas"

          if (!(Test-Path $dst)) { New-Item -ItemType Directory -Path $dst | Out-Null }

          robocopy $src $dst /MIR `
            /XD ".git" ".github" "infra" "docs" `
            /XF ".gitignore" `
            /R:2 /W:2

          $code = $LASTEXITCODE
          Write-Host "Robocopy exit code: $code"

          if ($code -ge 8) { exit $code }
          exit 0

      - name: Stop IIS
        shell: powershell
        run: |
          iisreset /stop

      - name: Install dependencies
        shell: powershell
        run: |
          cd C:\inetpub\project-atlas
          npm ci --omit=dev

      - name: Restart IIS
        shell: powershell
        run: |
          iisreset /start

      - name: Validate locally
        shell: powershell
        run: |
          (Invoke-WebRequest -UseBasicParsing http://localhost/health).Content
          (Invoke-WebRequest -UseBasicParsing http://localhost/version).Content
