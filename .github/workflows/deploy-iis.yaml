name: Deploy to IIS

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy files to IIS directory
        shell: powershell
        run: |
          $src = "$env:GITHUB_WORKSPACE"
          $dst = "C:\inetpub\project-atlas"

          if (!(Test-Path $dst)) {
            New-Item -ItemType Directory -Path $dst | Out-Null
          }

          robocopy $src $dst /MIR `
            /XD ".git" ".github" "infra" "docs" "node_modules" `
            /XF ".gitignore" `
            /R:2 /W:2

          $code = $LASTEXITCODE
          Write-Host "Robocopy exit code: $code"

          # Robocopy exit codes 0-7 are "success" states. 8+ means failure.
          if ($code -ge 8) { exit $code }
          exit 0

      - name: Install production dependencies
        shell: powershell
        run: |
          cd C:\inetpub\project-atlas

          # Avoid stale/locked artifacts
          if (Test-Path node_modules) {
            Remove-Item node_modules -Recurse -Force
          }

          npm ci --omit=dev

      - name: Recycle IIS App Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          Restart-WebAppPool -Name "Project-Atlas"

      - name: Validate locally
        shell: powershell
        run: |
          (Invoke-WebRequest -UseBasicParsing http://localhost/health).Content
          (Invoke-WebRequest -UseBasicParsing http://localhost/version).Content
